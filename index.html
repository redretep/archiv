<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>FragezeichenArchiv</title>
  <meta name="theme-color" content="#000000">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-black: #000000;
      --bg-dark: #121212;
      --bg-light: #181818;
      --bg-highlight: #282828;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --brand-green: #1db954;
      --sidebar-width: 250px;
      --player-height: 90px;
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-black);
      color: var(--text-primary);
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- LAYOUT --- */
    .main-container {
      display: flex;
      flex: 1;
      height: calc(100dvh - var(--player-height));
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--bg-black);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex-shrink: 0;
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .logo {
      font-size: 24px; font-weight: 700; color: var(--text-primary);
      display: flex; align-items: center; gap: 10px;
    }
    
    .archive-input-area {
      margin-top: auto;
      background: var(--bg-light); padding: 15px; border-radius: 8px;
    }
    .input-label { font-size: 11px; color: var(--text-secondary); font-weight: 700; margin-bottom: 8px; display: block; text-transform: uppercase;}
    .styled-input {
      width: 100%; padding: 10px; margin-bottom: 8px;
      background: #333; border: none; border-radius: 4px;
      color: white; font-size: 14px; outline: none;
    }
    .styled-btn {
      width: 100%; padding: 10px; background: var(--text-primary); color: black;
      border: none; border-radius: 20px; font-weight: 700;
      font-size: 13px; cursor: pointer; transition: 0.2s;
    }
    .styled-btn:hover { background: var(--brand-green); }

    .mobile-extras { display: none; } /* Hidden on PC */

    .sidebar-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 999; display: none;
      backdrop-filter: blur(2px);
    }

    /* Main Content */
    .content-area {
      flex: 1;
      background: linear-gradient(180deg, #202020 0%, var(--bg-dark) 100%);
      margin: 8px;
      border-radius: 8px;
      overflow-y: auto;
      padding: 24px;
      position: relative;
    }

    .header-bar {
      display: flex; align-items: center; gap: 15px;
      margin-bottom: 20px; position: sticky; top: 0; z-index: 10;
      background: inherit;
      padding-bottom: 10px;
    }
    
    .menu-btn {
      display: none; background: none; border: none; color: white;
      cursor: pointer; padding: 5px;
    }
    
    .search-container { flex: 1; }
    .search-container input {
      background: white; border: none; border-radius: 500px;
      padding: 10px 20px; width: 100%; max-width: 350px; color: black;
      font-weight: 500; outline: none; font-size: 16px;
    }

    /* --- GRID SYSTEM (Responsive) --- */
    .grid-container {
      display: grid;
      /* PC Default: Minimum 180px width per card */
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      padding-bottom: 50px;
      width: 100%; /* Ensure container doesn't overflow */
    }

    .card {
      background-color: var(--bg-light);
      padding: 16px; border-radius: 8px;
      transition: background-color 0.3s ease; cursor: pointer;
      display: flex; flex-direction: column; position: relative;
      overflow: hidden; /* Prevents internal content from breaking layout */
    }
    .card:hover { background-color: var(--bg-highlight); }
    
    .card-img-wrapper {
      width: 100%; aspect-ratio: 1; margin-bottom: 12px;
      box-shadow: 0 8px 15px rgba(0,0,0,0.5);
      border-radius: 4px; overflow: hidden; position: relative;
      background: #333;
    }
    .card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    
    .play-overlay {
      position: absolute; bottom: 8px; right: 8px; width: 40px; height: 40px;
      background-color: var(--brand-green); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transform: translateY(8px); transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .card:hover .play-overlay { opacity: 1; transform: translateY(0); }

    .card-title {
      font-weight: 700; color: var(--text-primary); margin-bottom: 5px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px;
    }
    .card-desc {
      color: var(--text-secondary); font-size: 12px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      line-height: 1.4;
    }

    /* --- PLAYER BAR (PC Layout) --- */
    .player-bar {
      height: var(--player-height);
      background-color: var(--bg-black);
      border-top: 1px solid #282828;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; z-index: 200;
      position: relative;
    }

    .now-playing { display: flex; align-items: center; width: 30%; min-width: 150px; cursor: pointer; }
    .np-cover { width: 56px; height: 56px; margin-right: 12px; border-radius: 4px; object-fit: cover; background: #333; }
    .np-info { display: flex; flex-direction: column; overflow: hidden; margin-right: 10px; }
    .np-title { color: white; font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .np-artist { color: var(--text-secondary); font-size: 11px; margin-top: 2px;}

    /* Centered Controls for PC */
    .player-controls { 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      width: 40%; max-width: 722px; 
    }
    
    .control-buttons { display: flex; align-items: center; gap: 20px; margin-bottom: 5px; }
    .ctrl-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; }
    .ctrl-btn:hover { color: white; }
    .play-pause-btn {
      width: 32px; height: 32px; background: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; color: black;
      cursor: pointer; transition: transform 0.1s;
    }
    .play-pause-btn:hover { transform: scale(1.05); }

    .progress-container { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); user-select: none; }
    .progress-bar-wrapper {
      flex: 1; height: 4px; background: #535353; border-radius: 2px;
      cursor: pointer; position: relative;
      touch-action: none; padding: 5px 0; background-clip: content-box;
    }
    .progress-fill { width: 0%; height: 100%; background: white; border-radius: 2px; position: absolute; top: 5px; left: 0; pointer-events: none;}
    .progress-fill::after {
      content: ''; position: absolute; right: -6px; top: -3px; width: 10px; height: 10px;
      background: white; border-radius: 50%; display: none;
    }
    .progress-bar-wrapper:hover .progress-fill { background: var(--brand-green); }
    .progress-bar-wrapper:hover .progress-fill::after { display: block; }

    .extra-controls { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
    .timer-input {
      width: 40px; background: #333; border: none; color: white; text-align: center; border-radius: 4px; font-size: 12px; padding: 4px;
    }

    /* --- LOADING & MODALS --- */
    .loading-screen {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(18,18,18,0.9); z-index: 50;
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--brand-green);
      border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .info-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85); z-index: 2000; display: none;
      justify-content: center; align-items: center; backdrop-filter: blur(10px);
    }
    .info-box {
      background: #1e1e1e; padding: 25px; border-radius: 12px;
      max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.7); position: relative;
    }
    .close-btn { position: absolute; top: 15px; right: 15px; color: white; background: none; border: none; font-size: 28px; cursor: pointer; }

    /* --- MOBILE RESPONSIVE CSS --- */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed; top: 0; left: 0; height: 100dvh;
        transform: translateX(-100%);
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
      }
      .sidebar.active { transform: translateX(0); }
      .sidebar-overlay.active { display: block; }
      .mobile-extras { display: block; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
      
      .menu-btn { display: block; }
      .content-area { margin: 0; border-radius: 0; padding: 16px; padding-bottom: 120px; }
      
      /* --- FIXED GRID FOR MOBILE --- */
      .grid-container {
        /* This ensures no horizontal scrolling. 
           Cards will be at least 140px wide. 
           If the screen is smaller (rare), it wraps to 1 column. 
           If wider, it fits 2 or 3. */
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
        gap: 12px;
      }
      .card { padding: 10px; }
      .card-title { font-size: 13px; }
      .play-overlay { opacity: 1; transform: translateY(0); width: 30px; height: 30px; bottom: 5px; right: 5px; }

      /* Mobile Player Bar - Layout Shift */
      .player-bar {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-rows: 4px auto; /* Row 1: Progress, Row 2: Controls */
        height: auto;
        padding: 0;
        padding-bottom: var(--safe-area-bottom);
        position: fixed; bottom: 0; width: 100%;
        background: rgba(18,18,18,0.98);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-top: none;
      }

      /* Move Progress Bar to Absolute Top of Player for Mobile */
      .progress-container {
        grid-column: 1 / -1; grid-row: 1;
        width: 100%; gap: 0; margin: 0;
        height: 14px; /* Touch area height */
        align-items: flex-start;
      }
      .progress-bar-wrapper {
        border-radius: 0; background: #333; height: 2px; padding: 6px 0; width: 100%;
      }
      .progress-fill { border-radius: 0; height: 2px; top: 6px; }
      .progress-container span { display: none; } /* Hide time numbers on mobile bar to save space */

      /* Now Playing Info */
      .now-playing {
        grid-column: 1; grid-row: 2;
        width: 100%; margin: 0; padding: 12px;
        border-bottom: none;
      }
      .np-cover { width: 42px; height: 42px; }

      /* Controls */
      .player-controls {
        grid-column: 2; grid-row: 2;
        width: auto; flex-direction: row;
        padding-right: 16px;
        gap: 15px; margin: 0;
      }
      .control-buttons { margin: 0; gap: 10px; }
      .play-pause-btn { width: 40px; height: 40px; }
      
      /* Hide PC extras on mobile player bar (moved to sidebar) */
      .extra-controls { display: none; }
      .control-buttons .ctrl-btn:first-child { display: none; } /* Hide Prev button on mobile to save space */
    }
  </style>
</head>
<body>

  <!-- Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="logo">
        <svg fill="white" width="30" height="30" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
        <span>???Archiv</span>
      </div>
      
      <div class="archive-input-area">
        <label class="input-label">ARCHIV WECHSELN</label>
        <select id="presetSelector" class="styled-input" onchange="handlePresetChange()">
          <option value="dreifragezeichen">Die Drei ???</option>
          <option value="diedr3i">Die DR3i</option>
        </select>
        <input type="text" id="archiveIdInput" class="styled-input" placeholder="Custom ID" value="dreifragezeichen">
        <button onclick="loadCollection(); toggleSidebar()" class="styled-btn">Eigenes Archiv Laden</button>
      </div>

      <!-- Mobile Settings (Moved here for clean UI) -->
      <div class="mobile-extras">
        <label class="input-label">Einstellungen</label>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="number" id="sleepInputMobile" class="styled-input" style="width:60px; margin:0;" placeholder="Min">
          <button onclick="setSleepTimer('mobile')" class="styled-btn" style="width:auto;">Timer</button>
        </div>
        <button onclick="toggleSpeed()" class="styled-btn" style="margin-top:10px;">Geschwindigkeit: <span id="speedDisplayMobile">1x</span></button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-area">
      <div class="header-bar">
        <button class="menu-btn" onclick="toggleSidebar()">
          <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Suchen..." oninput="filterGrid()">
        </div>
      </div>

      <h2 style="margin-bottom: 15px; font-weight: 800; font-size: 22px;" id="collectionTitle">Lade Daten...</h2>
      
      <div class="loading-screen" id="loading">
        <div class="spinner"></div>
        <div style="color:white; font-weight:600;">Lade Daten...</div>
      </div>

      <div class="grid-container" id="gridContainer">
        <!-- Cards inserted by JS -->
      </div>
    </div>
  </div>

  <!-- Player Bar -->
  <div class="player-bar">
    <div class="now-playing" onclick="toggleInfo()">
      <img src="https://placehold.co/56/333/fff?text=?" alt="" class="np-cover" id="npCover">
      <div class="np-info">
        <div class="np-title" id="npTitle">Bereit</div>
        <div class="np-artist" id="npArtist">-</div>
      </div>
    </div>

    <div class="player-controls">
      <div class="control-buttons">
        <button class="ctrl-btn" onclick="prevTrack()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button class="play-pause-btn" id="mainPlayBtn" onclick="togglePlay()">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" id="playIcon"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button class="ctrl-btn" onclick="nextTrack()"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
      </div>
      
      <!-- Progress Bar (Visible here on PC, moved to top via CSS grid on Mobile) -->
      <div class="progress-container">
        <span id="currTime">0:00</span>
        <div class="progress-bar-wrapper" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span id="totalTime">0:00</span>
      </div>
    </div>

    <div class="extra-controls">
      <input type="number" id="sleepInput" class="timer-input" placeholder="Min">
      <button class="ctrl-btn" onclick="setSleepTimer()" style="font-size:12px;">Set</button>
      <button class="ctrl-btn" id="speedBtn" onclick="toggleSpeed()" style="font-size:12px; font-weight:700; width:30px;">1x</button>
    </div>
  </div>

  <audio id="audioPlayer" preload="metadata"></audio>

  <!-- Info Overlay -->
  <div class="info-overlay" id="infoOverlay" onclick="if(event.target===this) toggleInfo()">
    <div class="info-box">
      <button class="close-btn" onclick="toggleInfo()">&times;</button>
      <div style="display:flex; gap:15px; margin-bottom:20px;">
        <img src="" id="infoCover" style="width:100px; height:100px; border-radius:6px; object-fit:cover;">
        <div>
          <h2 id="infoTitle" style="font-size:18px; line-height:1.2; margin-bottom:5px;">Titel</h2>
          <p id="infoAuthor" style="color:#b3b3b3; font-size:14px;">Autor</p>
          <p id="infoYear" style="color:#888; font-size:12px; margin-top:5px;"></p>
        </div>
      </div>
      <div id="infoDesc" style="color:#ddd; line-height:1.6; font-size:14px;"></div>
    </div>
  </div>

  <script>
    // --- GLOBAL VARIABLES ---
    let localDB = {}; 
    let currentPlaylist = [];
    let currentIndex = -1;
    let sleepTimerRef = null;
    let speed = 1;
    let isDragging = false; 

    // --- ELEMENTS ---
    const player = document.getElementById('audioPlayer');
    const loading = document.getElementById('loading');
    const playIconPath = document.querySelector('#playIcon path');
    const gridContainer = document.getElementById('gridContainer');
    const progressBar = document.getElementById('progressBar');

    // --- INITIALIZATION ---
    async function init() {
      try {
        const response = await fetch('metadata.json');
        if (!response.ok) throw new Error("metadata.json nicht gefunden");
        localDB = await response.json();
      } catch (e) {
        console.log("Hinweis: Keine lokale metadata.json gefunden.");
      }

      loadCollection();
      setupMediaSession();
      setupProgressEvents();
    }

    // --- MEDIA SESSION API ---
    function setupMediaSession() {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.setActionHandler('play', () => togglePlay());
        navigator.mediaSession.setActionHandler('pause', () => togglePlay());
        navigator.mediaSession.setActionHandler('previoustrack', () => prevTrack());
        navigator.mediaSession.setActionHandler('nexttrack', () => nextTrack());
        navigator.mediaSession.setActionHandler('seekto', (details) => {
          if (details.seekTime && isFinite(details.seekTime)) player.currentTime = details.seekTime;
        });
      }
    }

    function updateMediaSession(track) {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: track.title,
          artist: track.artist,
          album: document.getElementById('collectionTitle').textContent,
          artwork: [
            { src: track.cover, sizes: '96x96', type: 'image/jpeg' },
            { src: track.cover, sizes: '512x512', type: 'image/jpeg' },
          ]
        });
      }
    }

    // --- LOGIC ---
    function findMetadata(fileName) {
      if (!localDB.serie) return null;
      const match = fileName.match(/(\d{1,3})/); 
      if (match) return localDB.serie.find(item => item.nummer === parseInt(match[0], 10));
      return null;
    }

    async function loadCollection() {
      const collectionId = document.getElementById('archiveIdInput').value.trim();
      if (!collectionId) return;

      loading.style.display = 'flex';
      document.getElementById('collectionTitle').textContent = collectionId;
      gridContainer.innerHTML = '';
      currentPlaylist = [];

      try {
        const res = await fetch(`https://archive.org/metadata/${collectionId}`);
        const data = await res.json();
        if (!data || !data.files) throw new Error("Keine Dateien");

        let files = data.files.filter(f => f.name.toLowerCase().endsWith('.mp3'));
        files.sort((a, b) => a.name.localeCompare(b.name));

        currentPlaylist = files.map((file, index) => {
          const meta = findMetadata(file.name);
          let title = file.name.replace('.mp3','').replace(/_/g,' ');
          let artist = "Unbekannt";
          let cover = "https://placehold.co/300/222/fff?text=?";
          let description = "Keine Beschreibung.";
          let year = "";

          if (meta) {
            title = `${meta.nummer}. ${meta.titel}`;
            artist = meta.autor;
            if (meta.links?.cover) cover = meta.links.cover;
            if (meta.beschreibung) description = meta.beschreibung;
            if (meta.veröffentlichungsdatum) year = meta.veröffentlichungsdatum.substring(0,4);
          }

          return { index, fileName: file.name, url: `https://archive.org/download/${collectionId}/${file.name}`, title, artist, cover, description, year };
        });

        renderGrid(currentPlaylist);
        if (data.metadata?.title) document.getElementById('collectionTitle').textContent = data.metadata.title;

      } catch (e) {
        gridContainer.innerHTML = `<div style="color:white; padding:20px;">Fehler: ${e.message}</div>`;
      } finally {
        loading.style.display = 'none';
      }
    }

    function renderGrid(tracks) {
      gridContainer.innerHTML = '';
      tracks.forEach(track => {
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => playTrack(track.index);
        card.innerHTML = `
          <div class="card-img-wrapper">
            <img src="${track.cover}" alt="cover" loading="lazy">
            <div class="play-overlay"><svg viewBox="0 0 24 24" width="20" height="20" fill="black"><path d="M8 5v14l11-7z"/></svg></div>
          </div>
          <div class="card-title">${track.title}</div>
          <div class="card-desc">${track.artist}</div>
        `;
        card.dataset.search = (track.title + " " + track.artist).toLowerCase();
        gridContainer.appendChild(card);
      });
    }

    async function playTrack(i) {
      currentIndex = i;
      const t = currentPlaylist[i];
      player.src = t.url;
      try {
        await player.play();
        playIconPath.setAttribute('d', 'M6 19h4V5H6v14zm8-14v14h4V5h-4z');
        updateMediaSession(t);
      } catch (err) { console.error("Playback error", err); }
      
      document.getElementById('npTitle').textContent = t.title;
      document.getElementById('npArtist').textContent = t.artist;
      document.getElementById('npCover').src = t.cover;
      document.getElementById('infoTitle').textContent = t.title;
      document.getElementById('infoAuthor').textContent = t.artist;
      document.getElementById('infoDesc').textContent = t.description;
      document.getElementById('infoCover').src = t.cover;
      document.getElementById('infoYear').textContent = t.year;
    }

    // --- CONTROLS ---
    function togglePlay() {
      if (player.paused) {
        player.play();
        playIconPath.setAttribute('d', 'M6 19h4V5H6v14zm8-14v14h4V5h-4z');
      } else {
        player.pause();
        playIconPath.setAttribute('d', 'M8 5v14l11-7z');
      }
    }
    function nextTrack() { if (currentIndex < currentPlaylist.length - 1) playTrack(currentIndex + 1); }
    function prevTrack() { 
      if (player.currentTime > 3) player.currentTime = 0;
      else if (currentIndex > 0) playTrack(currentIndex - 1); 
    }
    
    function setSleepTimer(origin) {
      const inputId = origin === 'mobile' ? 'sleepInputMobile' : 'sleepInput';
      const min = document.getElementById(inputId).value;
      if (!min) return;
      if (sleepTimerRef) clearTimeout(sleepTimerRef);
      alert(`Timer gesetzt: ${min} Min`);
      sleepTimerRef = setTimeout(() => { player.pause(); }, min * 60000);
    }
    function toggleSpeed() {
      speed = speed >= 2 ? 0.5 : speed + 0.25;
      player.playbackRate = speed;
      document.getElementById('speedBtn').textContent = speed + 'x';
      document.getElementById('speedDisplayMobile').textContent = speed + 'x';
    }

    // --- PROGRESS ---
    function setupProgressEvents() {
      const updateProgress = (clientX) => {
        const rect = progressBar.getBoundingClientRect();
        let pos = (clientX - rect.left) / rect.width;
        pos = Math.max(0, Math.min(1, pos));
        document.getElementById('progressFill').style.width = (pos * 100) + '%';
        if (player.duration) player.currentTime = pos * player.duration;
      };

      progressBar.addEventListener('mousedown', (e) => { isDragging = true; updateProgress(e.clientX); });
      window.addEventListener('mousemove', (e) => { if (isDragging) updateProgress(e.clientX); });
      window.addEventListener('mouseup', () => { isDragging = false; });

      progressBar.addEventListener('touchstart', (e) => { isDragging = true; updateProgress(e.touches[0].clientX); }, {passive: false});
      progressBar.addEventListener('touchmove', (e) => { if (isDragging) { e.preventDefault(); updateProgress(e.touches[0].clientX); }}, {passive: false});
      progressBar.addEventListener('touchend', () => { isDragging = false; });
    }

    player.addEventListener('timeupdate', () => {
      if (!isDragging && player.duration) {
        const pct = (player.currentTime / player.duration) * 100;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('currTime').textContent = fmtTime(player.currentTime);
        document.getElementById('totalTime').textContent = fmtTime(player.duration);
      }
    });
    player.addEventListener('ended', nextTrack);

    function fmtTime(s) {
      if (!s || isNaN(s)) return "0:00";
      const m = Math.floor(s/60), sec = Math.floor(s%60);
      return `${m}:${sec.toString().padStart(2,'0')}`;
    }

    // --- UI HELPERS ---
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      document.getElementById('sidebarOverlay').classList.toggle('active');
    }
    function handlePresetChange() {
      document.getElementById('archiveIdInput').value = document.getElementById('presetSelector').value;
    }
    function filterGrid() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.card').forEach(c => {
        c.style.display = c.dataset.search.includes(q) ? 'flex' : 'none';
      });
    }
    function toggleInfo() {
      const el = document.getElementById('infoOverlay');
      el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    window.onload = init;
  </script>
</body>
</html>
